import streamlit as st
import pandas as pd
import requests
import plotly.graph_objects as go
import plotly.express as px
from datetime import datetime, timedelta
import time
import json
import os

# --- CONFIGURAZIONE PAGINA ---
st.set_page_config(
    page_title="Mitragliere Terminal V2",
    layout="wide",
    page_icon="ðŸ’£",
    initial_sidebar_state="collapsed"
)

# --- FILE SYSTEM PER STORICO ---
HISTORY_FILE = "equity_history.json"
START_DATE = "2025-11-30" 

# --- URLs (Network Bridge Standard) ---
URLS = {
    "manager": "http://position-manager-agent:8000",
    "sentiment": "http://news-sentiment-agent:8000",
    "technical": "http://technical-analyzer-agent:8000"
}

# --- CSS FUTURISTICO / CYBERPUNK ---
st.markdown("""
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap');

    /* SFONDO E FONT GLOBALI */
    .stApp {
        background-color: #050505;
        background-image: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #000000 100%);
        color: #e0e0e0;
        font-family: 'Roboto Mono', monospace;
    }
    
    h1, h2, h3 {
        font-family: 'Orbitron', sans-serif;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: #00ff88;
        text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
    }

    /* METRICHE NEON */
    div[data-testid="stMetric"] {
        background-color: rgba(20, 20, 20, 0.8);
        border: 1px solid #333;
        border-left: 5px solid #00ff88;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0, 255, 136, 0.1);
        transition: transform 0.2s;
    }
    div[data-testid="stMetric"]:hover {
        transform: scale(1.02);
        border-left: 5px solid #00ccff;
        box-shadow: 0 0 20px rgba(0, 204, 255, 0.2);
    }
    div[data-testid="stMetricValue"] {
        font-family: 'Orbitron', sans-serif;
        font-size: 24px !important;
        color: #fff !important;
    }

    /* TABELLE */
    .dataframe {
        font-family: 'Roboto Mono', monospace;
        background-color: rgba(255, 255, 255, 0.05);
    }

    /* LOGS CONSOLE STYLE */
    .console-log {
        background-color: #000;
        border: 1px solid #333;
        color: #0f0;
        font-family: 'Courier New', monospace;
        padding: 10px;
        height: 300px;
        overflow-y: scroll;
        font-size: 12px;
        border-radius: 5px;
    }

    /* PULSANTI */
    .stButton>button {
        background-color: #000;
        color: #00ff88;
        border: 1px solid #00ff88;
        font-family: 'Orbitron', sans-serif;
    }
    .stButton>button:hover {
        background-color: #00ff88;
        color: #000;
        box-shadow: 0 0 10px #00ff88;
    }
    
    /* NEWS TICKER */
    .news-card {
        background: rgba(255, 255, 255, 0.05);
        border-left: 3px solid #ffcc00;
        padding: 10px;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }
    </style>
    """, unsafe_allow_html=True)

# --- FUNZIONI UTILITÃ€ ---
def fetch(url, endpoint, default=None):
    try:
        r = requests.get(f"{url}{endpoint}", timeout=1.5)
        if r.status_code == 200: return r.json()
    except: pass
    return default

def load_local_history():
    """Carica lo storico persistente dal file JSON"""
    if os.path.exists(HISTORY_FILE):
        try:
            with open(HISTORY_FILE, "r") as f:
                return json.load(f)
        except: pass
    return []

def save_local_history(new_data):
    """Salva i nuovi dati unendoli ai vecchi"""
    history = load_local_history()
    # Set di timestamp esistenti per evitare duplicati
    timestamps = {h['time'] for h in history}
    
    changed = False
    for item in new_data:
        if item.get('time') and item['time'] not in timestamps:
            history.append(item)
            changed = True
    
    if changed:
        # Ordina per data
        history.sort(key=lambda x: x['time'])
        # Manteniamo solo gli ultimi 1000 punti per non appesantire
        with open(HISTORY_FILE, "w") as f:
            json.dump(history[-1000:], f) 
    return history

def translate_action(text):
    """Traduttore per i log"""
    if not text: return ""
    text = text.replace("Opening", "APERTURA").replace("OPENED", "APERTO")
    text = text.replace("CLOSED", "CHIUSO").replace("Moving SL", "SPOSTAMENTO SL")
    text = text.replace("Break Even", "PAREGGIO").replace("Rizzo", "Mitragliere")
    text = text.replace("to", "a").replace("with", "con").replace("Buy", "ACQUISTO").replace("Sell", "VENDITA")
    text = text.replace("HOLD", "ATTESA").replace("NO TRADES", "NESSUN TRADE")
    return text

def close_pos_req(symbol):
    try:
        requests.post(f"{URLS['manager']}/close_position", json={"symbol": symbol}, timeout=3)
        st.toast(f"ORDINE INVIATO: CHIUDERE {symbol}", icon="ðŸ’€")
        time.sleep(1)
        st.rerun()
    except: st.error("Errore chiusura")

# --- CARICAMENTO DATI ---
wallet = fetch(URLS['manager'], "/get_wallet_balance", {})
positions = fetch(URLS['manager'], "/get_open_positions", [])
logs = fetch(URLS['manager'], "/management_logs", [])
sent_data = fetch(URLS['sentiment'], "/global_sentiment", {})

# Gestione Equity Curve (Salvataggio locale)
raw_history = fetch(URLS['manager'], "/equity_history", [])
if raw_history:
    full_history = save_local_history(raw_history)
else:
    full_history = load_local_history()

# --- CALCOLI INTELLIGENTI ---
balance = wallet.get("balance", 0.0)
open_pnl = sum(p.get('pnl', 0) for p in positions) if positions else 0
equity = balance + open_pnl

# Commissioni Stimate (Bybit Taker 0.055% x 2 per Entrata/Uscita)
est_fees = 0.0
total_exposure = 0.0
if positions:
    for p in positions:
        size_usd = float(p['size']) * float(p['entry_price'])
        fees_pos = size_usd * 0.00055 * 2 # A/R stimato
        est_fees += fees_pos
        total_exposure += size_usd

# Statistiche del "Guardiano"
guardian_moves = len([l for l in logs if "Moving SL" in l.get('action', '')])
guardian_saved_est = guardian_moves * 15 # Stima

# --- HEADER DASHBOARD ---
c1, c2 = st.columns([3, 1])
with c1:
    st.title("ðŸ¦… MITRAGLIERE TERMINAL V2")
    st.caption(f"System Online | Connected to Matrix: 207.154.212.99 | Start: {START_DATE}")

with c2:
    if st.button("ðŸ”„ REFRESH DATA", use_container_width=True):
        st.rerun()

st.markdown("---")

# --- KPI ROW (NEON STYLE) ---
k1, k2, k3, k4, k5 = st.columns(5)

k1.metric("ðŸ’° SALDO WALLET", f"${balance:,.2f}", delta_color="off")
k2.metric("ðŸ“ˆ EQUITY NETTA", f"${equity:,.2f}", delta=f"{open_pnl:+.2f} PnL Aperto")
k3.metric("ðŸ›¡ï¸ GUARDIAN SAVES", f"{guardian_moves}", delta=f"~${guardian_saved_est} Salvati")
k4.metric("ðŸ’¸ COMMIS. STIMATE", f"-${est_fees:.2f}", help="Costo stimato apertura/chiusura posizioni correnti")
k5.metric("ðŸ’£ POSIZIONI", f"{len(positions)}", f"${total_exposure:,.0f} Esposizione")

# --- SEZIONE PRINCIPALE ---
col_main, col_side = st.columns([2, 1])

with col_main:
    # 1. GRAFICO EQUITY INTERATTIVO
    st.subheader("ðŸ“Š ANDAMENTO CONTO")
    
    if full_history:
        df = pd.DataFrame(full_history)
        
        fig = px.area(df, x='time', y='equity', template="plotly_dark")
        fig.update_traces(line_color='#00ff88', fillcolor='rgba(0, 255, 136, 0.1)')
        fig.update_layout(
            height=350,
            margin=dict(l=10, r=10, t=10, b=10),
            paper_bgcolor='rgba(0,0,0,0)',
            plot_bgcolor='rgba(0,0,0,0)',
            xaxis=dict(showgrid=False),
            yaxis=dict(showgrid=True, gridcolor='#333')
        )
        st.plotly_chart(fig, use_container_width=True)
    else:
        st.info("In attesa di dati storici per il grafico... (Il sistema sta registrando)")

    # 2. TABELLA POSIZIONI "CYBER"
    st.subheader("âš¡ POSIZIONI ATTIVE")
    if positions:
        df_pos = pd.DataFrame(positions)
        
        for i, row in df_pos.iterrows():
            with st.container():
                c_sym, c_lev, c_pnl, c_sl, c_act = st.columns([1.5, 1, 1.5, 1.5, 1])
                
                sym = row['symbol']
                pnl = float(row['pnl'])
                entry = float(row['entry_price'])
                sl = float(row['stop_loss'])
                
                # Calcolo distanza SL
                dist_sl_pct = ((entry - sl) / entry) * 100 if sl > 0 else 0
                
                pnl_color = "#00ff88" if pnl >= 0 else "#ff4444"
                
                c_sym.markdown(f"**{sym}**")
                c_sym.caption(f"Ingresso: ${entry:,.2f}")
                
                c_lev.markdown(f"x{row['leverage']:.0f}")
                c_lev.caption(row['side'])
                
                c_pnl.markdown(f"<span style='color:{pnl_color}; font-size:1.2rem; font-weight:bold'>${pnl:+.2f}</span>", unsafe_allow_html=True)
                
                sl_status = "ðŸ”’ BE (Risk Free)" if (row['side'] == "Buy" and sl > entry) or (row['side'] == "Sell" and sl < entry) else f"-{abs(dist_sl_pct):.2f}%"
                if sl == 0: sl_status = "âš ï¸ NO SL"
                
                c_sl.markdown(f"SL: ${sl:,.2f}")
                c_sl.caption(f"{sl_status}")
                
                if c_act.button("CHIUDI", key=sym):
                    close_pos_req(sym)
                
                st.markdown("<hr style='margin: 5px 0; border-color: #333'>", unsafe_allow_html=True)
    else:
        st.markdown("""
        <div style='padding: 30px; text-align: center; border: 1px dashed #444; border-radius: 10px;'>
            <h3 style='color: #666'>NESSUN BERSAGLIO INGAGGIATO</h3>
            <p>Il radar Ã¨ attivo. In attesa di occasioni tattiche.</p>
        </div>
        """, unsafe_allow_html=True)

with col_side:
    # 3. CERVELLO AI & SENTIMENT
    st.subheader("ðŸ§  INTELLIGENCE ROOM")
    
    # Sentiment
    score = sent_data.get("score", 50)
    label = sent_data.get("label", "Neutrale")
    st.markdown(f"**Sentiment Mercato:** {label} ({score}/100)")
    
    st.progress(score / 100)
    
    # Ultima Decisione Master
    st.markdown("**ðŸ¤– Ultimo Ordine Master:**")
    ai_logs = [l for l in logs if "EXEC" in l.get('action', '')]
    if ai_logs:
        last = ai_logs[0]
        st.success(f"{translate_action(last.get('action',''))}")
    else:
        st.text("Nessun ordine recente.")

    # News Ticker
    st.markdown("---")
    st.markdown("**ðŸ“° Ultime Notizie (Analizzate):**")
    # Placeholder statici in attesa che l'agente Sentiment passi il testo reale
    news_items = [
        "Analisi VolatilitÃ  Crypto in corso...",
        "Monitoraggio Zone di Liquidazione",
        "Controllo Correlazione BTC/S&P500"
    ]
    
    for n in news_items:
        st.markdown(f"<div class='news-card'>{n}</div>", unsafe_allow_html=True)

# --- LOG CONSOLE ---
st.markdown("---")
st.subheader("ðŸ“œ LOG DI MISSIONE (LIVE)")
log_html = "<div class='console-log'>"
if logs:
    for l in logs[:30]:
        color = "#00ff88" if l.get('status') == 'success' else ("#ffaa00" if l.get('status') == 'warning' else "#00ccff")
        line = f"<span style='color: #666'>[{l.get('time')}]</span> <span style='color: {color}'><b>{l.get('pair')}</b></span>: {translate_action(l.get('action'))}<br>"
        log_html += line
else:
    log_html += "In attesa di log dal sistema..."
log_html += "</div>"
st.markdown(log_html, unsafe_allow_html=True)

# Auto-refresh (silenzioso per non ricaricare la pagina intera)
time.sleep(30)
st.rerun()
