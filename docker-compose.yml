services:
  01_technical_analyzer:
    build: ./agents/01_technical_analyzer
    container_name: 01_technical_analyzer
    ports:
      - "8001:8000"
    env_file: .env
    restart: always
    networks:
      - trading-network

  03_fibonacci_agent:
    build: ./agents/03_fibonacci_agent
    container_name: 03_fibonacci_agent
    ports:
      - "8003:8000"
    env_file: .env
    restart: always
    networks:
      - trading-network

  04_master_ai_agent:
    build: ./agents/04_master_ai_agent
    container_name: 04_master_ai_agent
    ports:
      - "8004:8000"
    env_file: .env
    restart: always
    volumes:
      - shared_data:/data
    networks:
      - trading-network

  05_gann_analyzer_agent:
    build: ./agents/05_gann_analyzer_agent
    container_name: 05_gann_analyzer_agent
    ports:
      - "8005:8000"
    env_file: .env
    restart: always
    networks:
      - trading-network

  06_news_sentiment_agent:
    build: ./agents/06_news_sentiment_agent
    container_name: 06_news_sentiment_agent
    ports:
      - "8006:8000"
    env_file: .env
    restart: always
    networks:
      - trading-network

  07_position_manager:
    environment:
      MIN_SL_MOVE_DEFAULT: "0.001"
      POSITION_MANAGER_ENABLE_REVERSE: "true"
      POSITION_MANAGER_MANUAL_ONLY: "true"
      DEBUG_SYMBOLS:  "BTCUSDT,ETHUSDT,SOLUSDT"
      WARNING_THRESHOLD: "-0.02"          # -2% ROI lev
      AI_REVIEW_THRESHOLD: "-0.025"        # -4% ROI lev  
      REVERSE_THRESHOLD: "-0.03"          # -6% ROI lev
      HARD_STOP_THRESHOLD: "-0.05"        # -10% ROI lev
      # --- TRAILING basato su movimento RAW (leverage independent) ---
      TRAILING_ACTIVATION_RAW_PCT: "0.0010"    # 0.6% raw
      BREAKEVEN_ACTIVATION_RAW_PCT: "0.008"   # 0.8% raw

      # clamp distanza trailing (raw)
      TRAIL_MIN_DIST_RAW_PCT: "0.004"
      TRAIL_MAX_DIST_RAW_PCT: "0.025"         # 2.5% max: evita trailing troppo largo (BE-blocco)

      # dwell-time tightening (stringe solo dopo consolidamento)
      TRAIL_TIGHTEN_AFTER_SEC: "180"          # 3 minuti
      TRAIL_TIGHTEN_ZONE_PCT: "0.003"         # 0.30% zona vicino a peak/trough
      TRAIL_TIGHTEN_STEP: "0.85"              # -15% distanza per step
      TRAIL_TIGHTEN_MIN_PCT: "0.008"          # 0.8% minimo dopo tightening
      TRAIL_TIGHTEN_MAX_STEPS: "4"
      # profit-lock minimo quando ROI leveraged >= 2.5%
      PROFIT_LOCK_1_ACTIVATION_LEV_PCT: "0.025"
      PROFIT_LOCK_1_MARGIN_RAW_PCT: "0.0018"
      # Profit lock a scalini (leva-indipendente): trigger_raw:lock_raw
      PROFIT_LOCK_RAW_STEPS: "0.006:0.0018,0.010:0.0035,0.012:0.0060,0.016:0.0090,0.020:0.0120"
      EQUITY_HISTORY_FILE: "/data/equity_history.json"
    build: ./agents/07_position_manager
    container_name: 07_position_manager
    ports:
      - "8007:8000"
    env_file: .env
    restart: always
    volumes:
      - shared_data:/data
    networks:
      - trading-network

  08_forecaster_agent:
    build: ./agents/08_forecaster_agent
    container_name: 08_forecaster_agent
    ports:
      - "8008:8000"
    env_file: .env
    restart: always
    networks:
      - trading-network

  orchestrator:
    build: ./agents/orchestrator
    container_name: orchestrator
    environment:
      - PYTHONUNBUFFERED=1
      - DASHBOARD_RESET_PASSWORD=181279
    env_file: .env
    restart: always
    volumes:
      - shared_data:/data
    networks:
      - trading-network

  10_learning_agent:
    build: ./agents/10_learning_agent
    container_name: 10_learning_agent
    ports:
      - "8010:8000"
    environment:
      - PYTHONUNBUFFERED=1
      - EVOLUTION_INTERVAL_HOURS=48
      - MIN_TRADES_FOR_EVOLUTION=5
      - BACKTEST_IMPROVEMENT_THRESHOLD=0.5
      - MAX_STRATEGY_ARCHIVE=20
    env_file: .env
    restart: always
    volumes:
      - shared_data:/data
    networks:
      - trading-network

  dashboard:
    build: ./dashboard
    container_name: dashboard
    ports:
      - "8080:8080"
    environment:
      - PYTHONUNBUFFERED=1
    env_file: .env
    restart: always
    volumes:
      - shared_data:/data
    networks:
      - trading-network

networks:
  trading-network:
    driver: bridge

volumes:
  shared_data:
